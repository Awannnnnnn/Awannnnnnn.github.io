---
title: PFCP 在 5GC 核心網的互動講解
date: 2024-03-03 14:11:43
tags:
- [筆記]
- [5GC]
- [PFCP]
---

研究所的題目是 5GC 相關的，近期有讀者寄信詢問內容，這邊直接提供一個實際的例子，讓大家比較好理解 PFCP 在5G 中的用途

我的論文連結在此，可自行閱讀 </br>
[5G 資料層功能卸載： 基於 P4 之 5G 資料層的實作與部署](<https://ndltd.ncl.edu.tw/cgi-bin/gs32/gsweb.cgi/ccd=vXmqwX/record?r1=1&h1=0>)

<br>
<!-- more -->

> 以下是直接複製貼上之前給讀者的 email 內容，這邊盡量以白話文的方式來說明，細節與更專業的術語歡迎大家自行閱讀文件 TS 29.244 與 google

------

PFCP 是用在控制層，負責 SMF 與 UPF 之間的溝通，封包中承載的內容是 user plane 資料流的需求內容，實際來看一個範例內容。

這個圖片在論文裡也有，圖片中展示了完整的 PFCP 對話過程會有哪些封包 (session 建立、establish、modification、另外還有 removal request/response 只是圖片裡沒有呈現)
![PFCP PCAP file](file:///D:\awan_blog\photo\pfcp-instroduction\pcap.png)

往 PFCP Session Establish Request 這個封包裡面看，就可以看到你一開始提到的 Outer Header Removal Description: GTP-U/UDP/IPv4 (0) ，他是藏在 PDR 這個 IE 裡面
單看這個封包內容是在說：
Outer Header Removal Description = 0，我 (PFCP) 現在攜帶的這個封包內容是下行的封包內容；
我攜帶的封包內容是一個要從 DN 192.168.122.41 送往 UE 60.60.0.1 的封包 (127.0.0.1 是 SMF，127.0.0.7 是 UPF)
![PFCP PCAP detail](file:///D:\awan_blog\photo\pfcp-instroduction\pcap_detailed.png)

當 PFCP 把這些告訴 UPF 之後，UPF 會把這個封包訊息(包含 UE ip, DN ip, PDI, PDR id, FAR ID ...) 記下來，當 UPF 收到從 192.168.122.41 過來的封包之後，他就去查自己的資料庫，知道說這個封包是要進入 5G  核心網並送往 60.60.0.1 這個 UE 端，那因為封包已經要進入核心網了，為了安全性以及 QoS，不可能直接把封包丟去 60.60.0.1，這時候就會用到 GTP header。

PFCP 在初期建立對話時，基本上都是由 UE 提出想建立連結的需求，因此 5G 核心網知道 60.60.0.1 這個 UE 是在哪一個 gNB 基地台 底下，那他就會建立 GTP Header 在 gNB 和 UPF 之間。

回到上上段的結尾，UPF 為了把封包傳送去 60.60.0.1，他知道要去到核心網，也知道要先傳給哪一個 gNB ，因此 UPF 在傳送這個UE封包之前，會把 GTP Header 放上去，連同 gNB ip、PDR id、QER id (這會用來標示這顆封包想要的 QoS服務)、FAR id 等等，傳送出去到了基地台，基地台就會把 GTP Header 拿掉，才原原本本的把封包傳給 UE 60.60.0.1

那反之，如果今天是 UE 要 uplink 丟了一個封包給基地台，基地台就會把封包裝上 GTP Header，並傳給 UPF，UPF 知道要去的目的地在哪，就把 GTP Header 拆掉，原原本本的把封包送去目標 ip。

以上就是控制層SMF 利用 PFCP 傳遞對應的封包，讓資料層 UPF 知道怎麼出裡接收到的 user plane 封包的過程

補充：在論文中沒有特別劃出 gNB 這個腳色，是因為 UERANSIM 這個軟體直接模擬了 UE+RAN(基地台)，所以從 UERANSIM 出來的封包已經是 GTP 封包了，請參考下圖
![PFCP PCAP detail](file:///D:\awan_blog\photo\pfcp-instroduction\ueransim.png)

----

PFCP 講解結束，若有錯誤，歡迎留言協助修正，謝謝